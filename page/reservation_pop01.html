<!DOCTYPE html>
<html lang="ko">
@@include('../_include/head.html')
<body>
<div id="wrap">
    @@include('../_include/header.html')	
    <div id="container">
        @@include('../_include/lnb.html')

        <div class="inner">
            <div class="content reservation">
                <div class="content_h"></div>
                
            </div>
        </div>
    </div>
</div>

<!-- Table Modal  -->
<div id="pop_reservation">
		
	<div class="pop_contents">	
		<div class="reservation">
            <div class="row">
                <div class="col">
                    <div class="box_section group_place mt0">
                        <div class="search_filter schedule_area">
                            <ul>
                                <li class="form_datetime">
                                    <div class="label_t"><span class="essential" title="필수">탑승 일시</span></div>
                                    <input type="text" name="" class="form_ctl datepicker" placeholder="YYYY-MM-DD" disabled />
                                    <input type="text" class="form_ctl w_small timepicker" name="" placeholder="00:00" disabled />
                                    <div class="label_t"><span class="essential" title="필수">탑승 인원</span></div>
                                    <div class="wrap_count">
                                        <button type="button" class="btn_plus" disabled></button>
                                        <input type="text" class="form_ctl" value="0" disabled>
                                        <button type="button" class="btn_minus" disabled></button>
                                    </div>
                                </li>
                                <li>
                                    <div class="label_t"><span>예약자</span></div>
                                    <input type="text" class="form_ctl" placeholder="전화번호 입력" value="010-1234-5678" disabled>
                                </li>
                            </ul>
                        </div>

                        <div class="search_filter place_area">
                            <ul>
                                <li class="form_select point_start">
                                    <div class="label_t"><span class="essential" title="필수">탑승지</span></div>
                                    <div class="wrap_auto">
                                        <input type="text" class="form_ctl f_search startPoint" placeholder="탑승지를 선택해 주세요">
                                        <button type="button" class="btn btn_clear ir">초기화</button>
                                    </div>
                                    <button type="button" class="btn btn_gray btn_outline btn_add">경유지 추가</button>
                                </li>
                                <li class="form_select point_end">
                                    <div class="label_t"><span class="essential" title="필수">하차지</span></div>
                                    <div class="wrap_auto">
                                        <input type="text" class="form_ctl f_search endPoint" placeholder="하차지를 선택해 주세요">
                                        <button type="button" class="btn btn_clear ir">초기화</button>
                                    </div>
                                </li>
                                
                            </ul>
                        </div>

                        <div class="search_filter memo_area">
                            <ul>
                                <li class="form_memo">
                                    <div class="label_t"><span>접수메모</span></div>
                                    <input type="text" class="form_ctl" placeholder="메모 작성시 기사님에게 전달 드려요. (최대 30자)">
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="col group_map">
                    <div id="map_div" class="map_area"></div>
                    <div id="result" class="desc"></div>
                    <div class="label_area">
                        <span>탑승</span>
                        <span>빈차</span>
                    </div>
                    <div class="select_area">
                        <select name="" id="select-si" class="form_ctl" disabled>
                            <option value="">서울시</option>
                        </select>
                        <select name="" id="select-gu" class="form_ctl" disabled>
                            <option value="">종로구</option>
                        </select>
                        <select name="" id="select-agency" class="form_ctl" disabled>
                            <option value="">종로구 행복택시</option>
                        </select>
                        <select name="" id="select-center" class="form_ctl">
                            <option value="1">사직1</option>
                            <option value="2">사직2</option>
                        </select>
                    </div>
                </div>
            </div>
                
            <div class="box_section group_dispatch" style="height:170px">
                <div class="label_area">
                    <span>예약가능</span>
                    <span>예약</span>
                </div>
                <div id="grid_reservation" class="grid_list"></div>
            </div>
        </div>
	</div>
</div>
</body>
<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=l7xxb3b0b2ba959c4572891ba1bc2343cf6b"></script>
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=3okwk3rkyp"></script>
<script>
$(function () {

    $(document).on('click', '.wrap_count button', function(){
        var cls = $(this).attr('class');
        var val = $(this).siblings('input').val();
        var result;
        switch(cls) {
            case 'btn_plus':
                val < 45 ?  val ++ : val;
                break;
            case 'btn_minus':
                val > 0 ?  val -- : val;
                break;
        }
        $(this).siblings('input').val(val);
    });

    $(document).on('change', '#label_datetime', function(e) {
        if($(this).is(':checked')) {
            $(this).closest('.input_check').siblings().attr('disabled', false);
        }else {
            $(this).closest('.input_check').siblings().attr('disabled', true);
        }
    });

    var today = moment().format('YYYY-MM-DD');
    $('.form_datetime .datepicker').val(today);

    var time_current = moment().add(10, 'minutes').format('HH:mm');

    $('.timepicker').val(time_current);

    // 전화번호, 팁승지, 하치지 dropdown
    var arr_start = [
        "청와대 (서울 종로구 세종로 1)",
        "약선동 (서울 종로구 삼일대로 32길 51)",
        "혜화역 (서울 종로구 대학로 120 4호선 혜화역)",
        "종로3가 (서울 종로구 종로 129)",
        "창신동 (서울 종로구 지봉로 8-6)",
        "마로니에 공원 (서울 종로구 대학로 104)",
        "성대 정문 (서울 종로구 명륜 3가)",
        "이화마을 (서울 종로구 이화동 9-413)",
        "이화장 (서울 종로구 이화장 1길 32 우남이승만박사기념관)",
        "혜화동 로터리 (서울 종로구 혜화동)",
        "청와대 (서울 종로구 세종로 1)",
        "약선동 (서울 종로구 삼일대로 32길 51)",
        "혜화역 (서울 종로구 대학로 120 4호선 혜화역)",
        "종로3가 (서울 종로구 종로 129)",
        "창신동 (서울 종로구 지봉로 8-6)",
        "마로니에 공원 (서울 종로구 대학로 104)",
        "성대 정문 (서울 종로구 명륜 3가)",
        "이화마을 (서울 종로구 이화동 9-413)",
        "이화장 (서울 종로구 이화장 1길 32 우남이승만박사기념관)",
        "혜화동 로터리 (서울 종로구 혜화동)",
    ];
    var arr_end = [
        "청와대 (서울 종로구 세종로 1)",
        "약선동 (서울 종로구 삼일대로 32길 51)",
        "혜화역 (서울 종로구 대학로 120 4호선 혜화역)",
        "종로3가 (서울 종로구 종로 129)",
        "창신동 (서울 종로구 지봉로 8-6)",
        "마로니에 공원 (서울 종로구 대학로 104)",
        "성대 정문 (서울 종로구 명륜 3가)",
        "이화마을 (서울 종로구 이화동 9-413)",
        "이화장 (서울 종로구 이화장 1길 32 우남이승만박사기념관)",
        "혜화동 로터리 (서울 종로구 혜화동)",
        "청와대 (서울 종로구 세종로 1)1",
        "약선동 (서울 종로구 삼일대로 32길 51)2",
        "혜화역 (서울 종로구 대학로 120 4호선 혜화역)3",
        "종로3가 (서울 종로구 종로 129)4",
        "창신동 (서울 종로구 지봉로 8-6)5",
        "마로니에 공원 (서울 종로구 대학로 104)6",
        "성대 정문 (서울 종로구 명륜 3가)7",
        "이화마을 (서울 종로구 이화동 9-413)8",
        "이화장 (서울 종로구 이화장 1길 32 우남이승만박사기념관)9",
        "혜화동 로터리 (서울 종로구 혜화동)10",
    ];

    // input 입력시 btn_clear 활성화
    function checkSearchForm(target) {
        if(target.val() === ''){
            target.siblings('.btn_clear').removeClass('on');
        } else{
            target.siblings('.btn_clear').addClass('on');
        }
    }
    
    $(document).on("propertychange change keyup paste input", ".wrap_auto input", function() {
        var tg = $(this);
		checkSearchForm(tg);
    });
    // btn_clear 클릭시 input value 삭제
    $(document).on('click', '.wrap_auto .btn_clear', function(){
		$(this).siblings('.form_ctl').val('');
		$(this).removeClass('on');
	});


    // 경유지 추가
    $(document).on('click', '.btn_add', function(){
        var passlist = $('.point_pass');

        var contentString = [
            '<li class="form_select point_pass">',
            '   <div class="label_t"><span class="essential" title="필수">경유지' + (passlist.length + 1) + '</span></div>',
            '   <div class="wrap_auto">',
            '       <input type="text" class="form_ctl f_search passPoint" placeholder="경유지를 선택해 주세요">',
            '       <button type="button" class="btn btn_clear ir">초기화</button>',
            '   </div>',
            '   <button type="button" class="btn_delete ir">삭제</button>',
            '</li>'
        ].join('');

        if(passlist.length === 0) {
            $('.point_start').after(contentString);
        } else {
            $('.point_pass').eq(passlist.length - 1).after(contentString);
        }

        var arr_pass = [
            "청와대 (서울 종로구 세종로 1)",
            "약선동 (서울 종로구 삼일대로 32길 51)",
            "혜화역 (서울 종로구 대학로 120 4호선 혜화역)",
            "종로3가 (서울 종로구 종로 129)",
            "창신동 (서울 종로구 지봉로 8-6)",
            "마로니에 공원 (서울 종로구 대학로 104)",
            "성대 정문 (서울 종로구 명륜 3가)",
            "이화마을 (서울 종로구 이화동 9-413)",
            "이화장 (서울 종로구 이화장 1길 32 우남이승만박사기념관)",
            "혜화동 로터리 (서울 종로구 혜화동)",
        ];

        $('.passPoint').autocomplete({
            source : arr_pass,
            minLength : 0
        }).focus(function() {
            $(this).autocomplete("search", $(this).val());
        });
    });

    // 경유지 삭제
    $(document).on('click', '.btn_delete', function(){
        $(this).closest('li').remove();
    });
    
    // 지도 영역
    var map, mapOptions;
    var markerList = [];
    var arr_passList = [];  // 경유지
    var arr_blankList = [];  // 승하차 지점 
    var appKey = "l7xxb3b0b2ba959c4572891ba1bc2343cf6b";    // tmap
    
    var mapData = [
        {"title":"혜화역1", "address":"전북 무주군 무주읍 하장백길 71", "agency":"종로구 행복택시", "center":"사직1", "lat":36.028032030280826, "lon":127.70028359821887, "case":"start" },
        {"title":"혜화역2", "address":"전북 무주군 무주읍 한풍루로 251 무주공용버스터미널 전북 무주군 무주읍 한풍루로 251 무주공용버스터미널", "agency":"종로구 행복택시", "center":"사직2", "lat":36.00470830000012, "lon":127.66404465769727,  "case":"pass"},

        {"title":"혜화역2", "address":"전북 무주군 무주읍 한풍루로 251 무주공용버스터미널 전북 무주군 무주읍 한풍루로 251 무주공용버스터미널", "agency":"종로구 행복택시", "center":"사직2", "lat":36.00020830000012, "lon":127.61204465769727,  "case":"blank"},
        {"title":"혜화역2", "address":"전북 무주군 무주읍 한풍루로 251 무주공용버스터미널 전북 무주군 무주읍 한풍루로 251 무주공용버스터미널", "agency":"종로구 행복택시", "center":"사직2", "lat":36.02870830000012, "lon":127.62404465769727,  "case":"blank"},
        
        {"title":"혜화역3", "address":"전북 무주군 무주읍 가옥리 1054", "agency":"종로구 행복택시", "center":"사직3", "lat":35.97918884549752, "lon":127.65010275307006, "case":"pass"},
        {"title":"혜화역4", "address":"전북 무주군 부남면 대티길 58", "agency":"종로구 행복택시", "center":"사직4", "lat":35.99540252379289, "lon":127.57340466568048, "case":"end"},
    ];

    var carGpsData = [
        {"lat":36.008032030280826, "lon":127.70028359821887, "rotation":30, "status":"empty", "driver":"이재성1", "number":"울산 나 7431"},
        {"lat":36.00470830000012, "lon":127.64404465769727, "rotation":55, "status":"driving", "driver":"이재성2", "number":"울산 나 7432"},
        {"lat":35.97918884549752, "lon":127.62010275307006, "rotation":128, "status":"empty", "driver":"이재성3", "number":"울산 나 7433"},
    ];

    var mapData2 = [
        {"title":"혜화역1", "address":"테스트 1", "agency":"종로구 행복택시", "center":"사직1", "lat":37.4941465, "lon":127.0289518, "case":"start" },
        {"title":"혜화역2", "address":"테스트 2", "agency":"종로구 행복택시", "center":"사직2", "lat":37.545168, "lon":127.0880022, "case":"pass"},

        {"title":"혜화역2", "address":"테스트 2", "agency":"종로구 행복택시", "center":"사직2", "lat":37.525168, "lon":127.0680022, "case":"blank"},
        {"title":"혜화역3", "address":"테스트 3", "agency":"종로구 행복택시", "center":"사직3", "lat":37.5366681, "lon":126.9558969, "case":"blank"},

        {"title":"혜화역3", "address":"테스트 3", "agency":"종로구 행복택시", "center":"사직3", "lat":37.5566681, "lon":126.9758969, "case":"pass"},
        {"title":"혜화역4", "address":"테스트 4", "agency":"종로구 행복택시", "center":"사직4", "lat":37.5301315, "lon":126.9262302, "case":"end"},
    ];

    

    var carGpsData2 = [
        {"no":1, "lat":37.4841465, "lon":127.0089518, "rotation":30, "status":"empty", "driver":"이재성1", "number":"울산 나 7432"},
        {"no":2, "lat":37.565168, "lon":127.0880022, "rotation":55, "status":"driving", "driver":"이재성2", "number":"울산 나 7432"},
        {"no":3, "lat":37.5366681, "lon":126.9758969, "rotation":128, "status":"empty", "driver":"이재성3", "number":"울산 나 7432"},
    ];

    var info_title, info_address, info_agency, info_center = '';

    var contentString = [
            '<div class="iw_inner infowindow">',
            '   <h3>승하차지점 정보</h3>',
            '   <a href="javascript:void(0);" class="btn_close ir">정보 닫기</a>',
            '   <div class="table_list tableFixHead">',
            '       <table>',
            '           <thead>',
            '               <tr>',
            '                   <th>승하차지명</th>',
            '                   <th class="title">' + info_title + '</th>',
            '               </tr>',
            '           </thead>',
            '           <tbody>',
            '               <tr>',
            '                   <td>주소</td>',
            '                   <td class="address">' + info_address + '</td>',
            '               </tr>',
            '               <tr>',
            '                   <td>소속기관</td>',
            '                   <td class="agency">' + info_agency + '</td>',
            '               </tr>',
            '               <tr>',
            '                   <td>센터</td>',
            '                   <td class="center">' + info_center + '</td>',
            '               </tr>',
            '           </tbody>',
            '       </table>',
            '   </div>',
            '</div>'
        ].join('');

    var infowindow = new naver.maps.InfoWindow({
        content: contentString,
        backgroundColor: "transparent",
        borderWidth: 0,
        anchorSize: new naver.maps.Size(0, 0),
        pixelOffset: new naver.maps.Point(0, -10)
    });

    function addMarker(status, lon, lat, tag) {
        //출도착경유구분
        //이미지 파일 변경.    
        var markerLayer;
        var cls = '';
        var txt = '';
        var rotate = 0;
        var driver = '';
        var car_num = '';
        var zindex = 0;
        
        switch (status) {
            case "pinBlank":
                txt = tag;
                cls = "pin_blank";
                zindex = 1;
                break;

            case "pinStart":
                txt = '';
                cls = "pin_start";
                zindex = 3;
                break;
            case "pinPass":
                txt = '경유지' + tag;
                cls = "pin_pass";
                zindex = 3;
                break;
            case "pinEnd":
                txt = '';
                cls = "pin_end";
                zindex = 3;
                break

            case "car":
                txt = '';
                cls = "car";
                idx = tag.split('_')[1];
                rotate = carGpsData[idx].rotation;
                driver = carGpsData[idx].driver;
                car_num = carGpsData[idx].number;
                zindex = 4;
                break;
            case "carEmpty":
                txt = '';
                cls = "car car_empty";
                idx = tag.split('_')[1];
                rotate = carGpsData[idx].rotation;
                driver = carGpsData[idx].driver;
                car_num = carGpsData[idx].number;
                zindex = 2;
                break;
        };
        
        var marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(lat,lon),
            map: map,
            icon: {
                content: [
                    '<div class="pin ' + cls + '" style="transform:rotate(' + rotate + 'deg)">',
                        '<div class="pin_name">',
                            txt,
                        '</div>',
                    '</div>',
                    '<div class="label_car">',
                        '<span class="driver">' + driver + '</span>',
                        '<span class="car_num">' + car_num + '</span>',
                    '</div>',
                ].join(''),
                size: new naver.maps.Size(44, 36),
                anchor: new naver.maps.Point(22, 36),
            },
            draggable: false,
            zIndex: zindex
        });

        markerList.push(marker);

        marker.addListener("click", function(e) {
            if (infowindow.getMap()) {
                infowindow.close();
                $('.pin_pass').removeClass('on');
                $('.pin_blank').removeClass('on');
            } else {
                $('.pin_pass').removeClass('on');
                $('.pin_blank').removeClass('on');
                $('.car').removeClass('on');
                $(e.domEvent.target).addClass('on');
                
                if(!$(e.domEvent.target).hasClass('car')){
                    
                    infowindow.open(map, marker);

                    info_title = mapData[tag].title;
                    info_address = mapData[tag].address;
                    info_agency = mapData[tag].agency;
                    info_center = mapData[tag].center;

                    $('.infowindow').find('.title').text(info_title);
                    $('.infowindow').find('.address').text(info_address);
                    $('.infowindow').find('.agency').text(info_agency);
                    $('.infowindow').find('.center').text(info_center);

                    $('.infowindow').on('click', '.btn_close', function(){
                        infowindow.close();
                        $('.pin_pass').removeClass('on');
                    });

                    $.fn.hasScrollBar = function() {
                        return (this.prop("scrollHeight") == 0 && this.prop("clientHeight") == 0) || (this.prop("scrollHeight") > this.prop("clientHeight"));
                    };

                    if( $(".infowindow table tbody").hasScrollBar() ){
                        $(".infowindow table thead").addClass('hasscroll');
                    }
                } else {
                    console.log(e.overlay.car_num);
                    var selectedData = carGpsData.filter( item => {
                        return item.number === e.overlay.car_num;
                    })
                    console.log(selectedData[0]);
                }
            }
        });


        marker.tag = tag;
        marker.car_num = car_num;

        /* marker.addListener("dragend", function (evt) {
            // console.log(evt);
            // markerListenerEvent(evt);
        });
        marker.addListener("drag", function (evt) {   
            // console.log(evt);	
            markerObject = markerList[tag];
        }); */

        markerList[tag] = marker;
        return marker;
    }

    function createMarker(mapDataItems) {
        arr_passList = [];
        arr_blankList = [];

        for(var i = 0; i < mapDataItems.length; i ++){
            if(mapDataItems[i].case === 'start') {
                addMarker('pinStart', mapDataItems[0].lon, mapDataItems[0].lat, 0);
            } 
            else if(mapDataItems[i].case === 'end') {
                addMarker('pinEnd', mapDataItems[mapDataItems.length - 1].lon, mapDataItems[mapDataItems.length - 1].lat, i);
            }
            else if(mapDataItems[i].case === 'pass') {
                arr_passList.push(mapDataItems[i].lon + ',' + mapDataItems[i].lat);
                
            } else {
                arr_blankList.push(mapDataItems[i].lon + ',' + mapDataItems[i].lat);
            }
        }

        // 경유지 마커
        for(var i = 0; i < arr_passList.length; i ++){
            addMarker('pinPass', arr_passList[i].split(',')[0], arr_passList[i].split(',')[1], i + 1);
        }

        // 승하차 지점 마커
        for(var i = 0; i < arr_blankList.length; i ++){
            addMarker('pinBlank', arr_blankList[i].split(',')[0], arr_blankList[i].split(',')[1], i + 1);
        }
    }

    function createCars(gpsData) {
        for(var i = 0; i < gpsData.length; i ++){
            switch(gpsData[i].status) {
                case 'empty':
                    addMarker('carEmpty', gpsData[i].lon, gpsData[i].lat, 'car_' + i);
                    break;
                case 'driving':
                    addMarker('car', gpsData[i].lon, gpsData[i].lat, 'car_' + i);
                    break;
            }
        }
    }

    function drawData(data){
        // 지도위에 선은 다 지우기
        var resultStr = "";
        var distance = 0;
        var idx = 1;
        var newData = [];
        var equalData = [];
        var pointId1 = "-1234567";
        var ar_line = [];
        
        for (var i = 0; i < data.features.length; i++) {
            var feature = data.features[i];
            
            //배열에 경로 좌표 저장
            if(feature.geometry.type == "LineString"){
                ar_line = [];
                for (var j = 0; j < feature.geometry.coordinates.length; j++) {
                    var startPt = new naver.maps.LatLng(feature.geometry.coordinates[j][1],feature.geometry.coordinates[j][0]);
                    ar_line.push(startPt);
                }

                var polyline = new naver.maps.Polyline({
                    path: ar_line,
                    strokeColor: '#14429c',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    zIndex: 2,
                    clickable: true,
                    map: map
                });
            }
            var pointId2 = feature.properties.viaPointId;
            if (pointId1 != pointId2) {
                equalData = [];
                equalData.push(feature);
                newData.push(equalData);
                pointId1 = pointId2;
            }
            else {
                equalData.push(feature);
            }
        }
        geoData = newData;
    }

    function time(seconds) {
        //3항 연산자를 이용하여 10보다 작을 경우 0을 붙이도록 처리 하였다.
        var hour = parseInt(seconds/3600) < 10 ? '0'+ parseInt(seconds/3600) : parseInt(seconds/3600);
        var min = parseInt((seconds%3600)/60) < 10 ? '0'+ parseInt((seconds%3600)/60) : parseInt((seconds%3600)/60);
        var sec = seconds % 60 < 10 ? '0'+seconds % 60 : seconds % 60;

        //연산한 값을 화면에 뿌려주는 코드
        // document.getElementById("time").innerHTML = hour+":"+min+":" + sec;
        return hour+"시간 "+min+"분 " + sec + "초";
    }

    function Info(data) {
        /* 
            taxiFare // 택시 예상 요금 정보(단위:원)
            totalDistance // 경로 총 길이(단위: m)
            totalFare // 경로 총 요금 정보(단위:원)
            totalTime  // 경로 총 소요 시간(단위: 초)
            turnType // 회전 정보
        */

        var center = map.getCenter();//map의 중심 좌표 값
        var level = map.getZoom();//map의 ZoomLevel 값
        var extent = map.getBounds();//map의 영역의 값
        var km = data.totalDistance/1000;
        var totalDistance = km.toFixed(2);
        var totalTime = time(data.totalTime);
        var taxiFare = data.taxiFare.toLocaleString('ko-KR');
        var result =
                    // '중심좌표: '+center+'<br>'+
                    // '레벨: '+level+'<br>'+
                    // '영역값: '+extent+'<br>'+
                    '예상 주행 시간 : '+totalTime+'<br>'+
                    '예상 주행 거리: '+totalDistance+'km'+'<br>'+
                    '요금 정책: 미터기 요금';
                    // '요금 정책: '+taxiFare+'원';
        var resultDiv = document.getElementById("result");
        resultDiv.innerHTML = result;
    }

    var resultPolygon = [];
    var drawInfoArr = [];

    // 공간 API 사용 city_do(시도), gu_gun(시군구), legalDong(법정동), adminDong(행정동)
    function geofencingSpace(keyword, category) {
        var searchKeyword = keyword;
        var searchOption = category;
        var headers = {}; 
        headers["appKey"]=appKey;

        $.ajax({
            method : "GET",
            headers : headers,
            url : "https://apis.openapi.sk.com/tmap/geofencing/regions?version=1&format=json&callback=result",
            async : false,
            crossDomain : true,
            data : {
                "count" : "20",
                "categories" : searchOption,//categories,
                "searchType" : "KEYWORD",
                "searchKeyword" : searchKeyword,
            },
            success : function(response) {
                if(response){
                    // 3. regionId 얻기
                    var resultRegionsInfo = response.searchRegionsInfo;

                    for ( var i in resultRegionsInfo) {
                        var description = resultRegionsInfo[i].regionInfo.description;
                        var regionId = resultRegionsInfo[i].regionInfo.regionId;
                        
                    }

                    geofencingRegions(regionId)

                }
                else{
                    alert("잘못된 검색입니다.");
                }
            },
            error : function(request, status, error) {
                console.log("code:"
                        + request.status + "\n"
                        + "message:"
                        + request.responseText
                        + "\n" + "error:" + error);
            }
        });
    };

    // 영역API 사용요청
    function geofencingRegions(regionId) {
        $.ajax({
            method : "GET",
            url : "https://apis.openapi.sk.com/tmap/geofencing/regions/"
                    + regionId
                    + "?version=1&format=json&callback=result",
            async : false,
            data : {
                "resCoordType" : "EPSG3857",
                "appKey" : appKey,
            },
            success : function(response) {
                var resultGeometry = response.features[0].geometry;
                var resultArea = resultGeometry.coordinates[0];

                var resultProperties = response.features[0].properties.regionName;

                drawInfoArr = [];
                var polyline_;

                var positionBounds = new Tmapv2.LatLngBounds(); //맵에 결과물 확인 하기 위한 LatLngBounds객체 생성

                if(resultGeometry.type == "MultiPolygon"){
                    // console.log('MultiPolygon');
                    for(var i in resultGeometry.coordinates){
                        drawInfoArr = []; 
                        resultArea = resultGeometry.coordinates[i];
                        var resultArea_array = resultArea[0];
                        for(var j in resultArea_array){
                            
                            // 경로들의 결과값(구간)들을 포인트 객체로 변환 
                            var latlng = new Tmapv2.Point(resultArea_array[j][0], resultArea_array[j][1]);
                            // 포인트 객체를 받아 좌표값으로 변환
                            var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);
                            // 포인트객체의 정보로 좌표값 변환 객체로 저장
                            var convertChange = new Tmapv2.LatLng(convertPoint._lat, convertPoint._lng);
                            
                            drawInfoArr.push(convertChange);
                            positionBounds.extend(convertChange);
                        }
                        var polygon = new Tmapv2.Polygon({
                            paths: drawInfoArr,
                            strokeColor : "red",
                            fillColor:"pink", // 다각형 내부 색상
                            map: map // 지도 객체
                        });
                        resultPolygon.push(polygon);
                    }
                }
                
                else{
                    // console.log('Polygon');
                    for(var i in resultArea){
                        // 경로들의 결과값(구간)들을 포인트 객체로 변환 
                        var latlng = new Tmapv2.Point(resultArea[i][0], resultArea[i][1]);
                        // 포인트 객체를 받아 좌표값으로 변환
                        var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(latlng);

                        // console.log(latlng);
                        // 포인트객체의 정보로 좌표값 변환 객체로 저장
                        // var convertChange = new Tmapv2.LatLng(convertPoint._lat, convertPoint._lng);
                        
                        var convertChange = new naver.maps.LatLng(convertPoint._lat, convertPoint._lng);

                        drawInfoArr.push(convertChange);
                        // positionBounds.extend(convertChange);
                    }
                }
            },
            error : function(request, status, error) {
                console.log("code:" + request.status + "\n"
                        + "message:" + request.responseText + "\n"
                        + "error:" + error);
            }
        });
    };

    function createRoute(mapDataItems) {
        var appKey = appKey;
        var passList = arr_passList.join('_');
        var prtcl;
        var headers = {};
        headers["appKey"]=appKey;

        var arr_start = mapDataItems.filter((item) => {
            return item.case === 'start';
        });
        var arr_end = mapDataItems.filter((item) => {
            return item.case === 'end';
        });
        
        $.ajax({
            method:"POST", 
            headers : headers, 
            url:"https://apis.openapi.sk.com/tmap/routes?version=1&format=json",
            async:false,
            data:{ 
                startX : arr_start[0].lon,
                startY : arr_start[0].lat,
                endX : arr_end[0].lon,
                endY : arr_end[0].lat,
                passList : passList,
                reqCoordType : "WGS84GEO",
                resCoordType : "WGS84GEO",
                angle : "172",
                searchOption : "0",
                trafficInfo : "Y"
            },
            success:function(response){
                console.log('createRoute')
                prtcl = response;

                // 정보 표시
                Info(response.features[0].properties);
            
                //경로탐색 결과 Line 그리기
                drawData(prtcl);
            
                // 경로탐색 결과 반경만큼 지도 레벨 조정
                var newData = geoData[0];
                PTbounds = new naver.maps.LatLngBounds();
                for (var i = 0; i < newData.length; i++) {
                    var mData = newData[i];
                    var type = mData.geometry.type;
                    var pointType = mData.properties.pointType;
                    if(type == "Point"){
                        var linePt = new naver.maps.LatLng(mData.geometry.coordinates[1],mData.geometry.coordinates[0]);
                        PTbounds.extend(linePt);
                    }
                    else{
                        var startPt,endPt;
                        for (var j = 0; j < mData.geometry.coordinates.length; j++) {
                            var linePt = new naver.maps.LatLng(mData.geometry.coordinates[j][1],mData.geometry.coordinates[j][0]);
                            PTbounds.extend(linePt);
                        }
                    }
                }
                map.fitBounds(PTbounds);

                // black background 생성
                var gap = 0.02;
                var lb_y = PTbounds._min.y - 0.02;
                var lb_x = PTbounds._min.x - 0.02;
                var rt_y = PTbounds._max.y + 0.02;
                var rt_x = PTbounds._max.x + 0.02;

                var polygon = new naver.maps.Polygon({
                    map: map,
                    paths: [
                        [
                            new naver.maps.LatLng(41.921509, 119.3856758),
                            new naver.maps.LatLng(41.8049801, 136.849646),
                            new naver.maps.LatLng(28.3786463, 136.8833774),
                            new naver.maps.LatLng(32.2266773, 119.3787235),
                            new naver.maps.LatLng(41.921509, 119.3856758),
                        ],
                        drawInfoArr
                    ],
                    fillColor: '#000',
                    fillOpacity: 0.3,
                    strokeColor: '#000',
                    strokeOpacity: 0,
                    strokeWeight: 0,
                    zIndex: 500
                });
            },
            error:function(request,status,error){
                console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
        });

    }
    
    function createMap(mapDataItems, carGpsDataItems, dong, category){
        if(map !== undefined) {
            map.destroy();
        }
        
        mapOptions = {
            zoom: 12,
            minZoom: 9,
            maxZoom: 14
        };

        map = new naver.maps.Map('map_div', mapOptions);

        naver.maps.Event.addListener(map, 'click', function(e) {
            $('.pin_pass').removeClass('on');
            $('.pin_blank').removeClass('on');
            $('.car').removeClass('on');
            infowindow.close();
        });
        
        createMarker(mapDataItems); // 마커 생성
        createCars(carGpsDataItems);    // 차량 생성
        geofencingSpace(dong, category);
        createRoute(mapDataItems);  // 경로탐색 API 사용요청
    }

    $(document).on('selectmenuchange', '#select-center', function( event, ui ) { 
        switch(ui.item.value) {
            case '1':
                createMap(mapData, carGpsData, '무주읍', 'adminDong');
                break;
            case '2':
                createMap(mapData2, carGpsData2, '서울', 'city_do');
                break;
        }
    });

    // grid 배차
    var data_dispatch = {"data":[
        {"select":1,"driver":"이재성","car_num":"울산 나 7433","car_personnel":4,"car_type":"택시","notallowed":"11:30-15:20","hour07":"","hour08":"","hour09":"","hour10":"","hour11":"","hour12":"","hour13":"","hour14":"","hour15":"","hour16":"","hour17":"","hour18":"","hour19":"","hour20":"","hour21":""},
        // {"select":1,"driver":"이재성","car_num":"울산 나 7433","car_personnel":4,"car_type":"택시","notallowed":"11:20-15:00","hour07":"","hour08":"","hour09":"","hour10":"","hour11":"","hour12":"","hour13":"","hour14":"","hour15":"","hour16":"","hour17":"","hour18":"","hour19":"","hour20":"","hour21":""},
        // {"select":0,"driver":"이재성","car_num":"울산 나 7433","car_personnel":4,"car_type":"택시","notallowed":"11:10-15:30","hour07":"","hour08":"","hour09":"","hour10":"","hour11":"","hour12":"","hour13":"","hour14":"","hour15":"","hour16":"","hour17":"","hour18":"","hour19":"","hour20":"","hour21":""},
        // {"select":0,"driver":"이재성","car_num":"울산 나 7433","car_personnel":4,"car_type":"택시","notallowed":"11:00-15:10","hour07":"","hour08":"","hour09":"","hour10":"","hour11":"","hour12":"","hour13":"","hour14":"","hour15":"","hour16":"","hour17":"","hour18":"","hour19":"","hour20":"","hour21":""},
        // {"select":0,"driver":"이재성","car_num":"울산 나 7433","car_personnel":4,"car_type":"택시","notallowed":"10:50-15:00","hour07":"","hour08":"","hour09":"","hour10":"","hour11":"","hour12":"","hour13":"","hour14":"","hour15":"","hour16":"","hour17":"","hour18":"","hour19":"","hour20":"","hour21":""},
    ]};

    var data_selected = '09:00-09:40';  // 예약 시간 표시

    var colModel_dispatch = [
        { title: "선택", dataIndx: "select", width: 100, nodrag: true, nodrop: true, 
            render: function(ui) {
                var content = '';
                if(ui.cellData === 0) {
                    content = '<button type="button" class="btn btn_blue btn_dispatch" disabled>배차</button>';
                } else {
                    content = '<button type="button" class="btn btn_blue btn_dispatch">배차</button>';
                }
                return content;
            }, 
            postRender: function (ui) {
                var rowIndx = ui.rowIndx,
                    grid = this,
                    $cell = grid.getCell(ui);
                $cell.find(".btn_dispatch").bind("click", function (evt) {
                    var tg = $(this);
                    var rowdata = grid.getRowData({rowIndx: rowIndx})
                    console.log(rowdata)
                });
            },
        },
        { title: "기사", dataIndx: "driver", width: 100, nodrag: true, nodrop: true, },
        { title: "차량 번호", dataIndx: "car_num", width: 130, nodrag: true, nodrop: true, },
        { title: "탑승 가능 인원", dataIndx: "car_personnel", width: 130, nodrag: true, nodrop: true, },
        { title: "차량 유형", dataIndx: "car_type", width: 100, nodrag: true, nodrop: true, },
        { title: "07:00", dataIndx: "hour07", width: 100, nodrag: true, nodrop: true, cls: "merge_area", 
            render: function (ui) {
                var rowData = ui.rowData, dataIndx = ui.dataIndx, rowIndx = ui.rowIndx;
                var val = rowData[dataIndx];
                var notallowed = rowData.notallowed;

                function calcPos(time) {
                    var gap = 100/15;
                    var start = time.split('-')[0];
                    var start_hour = start.split(':')[0];
                    var start_min = start.split(':')[1];
                    var pos_left = (start_hour - 7)*gap + (start_min/60*gap);
                    return pos_left;
                }

                function calcWd(time) {
                    var gap = 100/15;
                    var end = time.split('-')[1];
                    var end_hour = end.split(':')[0];
                    var end_min = end.split(':')[1];
                    var wd = (end_hour - 7)*gap + (end_min/60*gap) - calcPos(time);
                    return wd;
                }
                
                var result = 	"<div class='bar'>" +
                                    "<span class='selected' style='left:" + calcPos(data_selected) + "%;width:" + calcWd(data_selected) + "%;'></span>" +
                                    "<span class='not' style='left:" + calcPos(notallowed) + "%;width:" + calcWd(notallowed) + "%;'></span>" +
                                "</div>";
                return result;
            },
            
        },
        { title: "08:00", dataIndx: "hour08", width: 100, nodrag: true, nodrop: true, },
        { title: "09:00", dataIndx: "hour09", width: 100, nodrag: true, nodrop: true, },
        { title: "10:00", dataIndx: "hour10", width: 100, nodrag: true, nodrop: true, },
        { title: "11:00", dataIndx: "hour11", width: 100, nodrag: true, nodrop: true, },
        { title: "12:00", dataIndx: "hour12", width: 100, nodrag: true, nodrop: true, },
        { title: "13:00", dataIndx: "hour13", width: 100, nodrag: true, nodrop: true, },
        { title: "14:00", dataIndx: "hour14", width: 100, nodrag: true, nodrop: true, },
        { title: "15:00", dataIndx: "hour15", width: 100, nodrag: true, nodrop: true, },
        { title: "16:00", dataIndx: "hour16", width: 100, nodrag: true, nodrop: true, },
        { title: "17:00", dataIndx: "hour17", width: 100, nodrag: true, nodrop: true, },
        { title: "18:00", dataIndx: "hour18", width: 100, nodrag: true, nodrop: true, },
        { title: "19:00", dataIndx: "hour19", width: 100, nodrag: true, nodrop: true, },
        { title: "20:00", dataIndx: "hour20", width: 100, nodrag: true, nodrop: true, },
        { title: "21:00", dataIndx: "hour21", width: 100, nodrag: true, nodrop: true, },
        
    ];
    
    var options_dispatch = {
        scrollModel: { autoFit: true },
        width: '100%',
        height: 'flex',
        maxHeight: 227,
        rowHt: 45,
        rowHtHead: 45,
        collapsible: {on: false, toggle: false},

        columnBorders: true,
        rowBorders: true,
        stripeRows: true,
        
        postRenderInterval: -1, //synchronous post rendering.
        dataModel: data_dispatch,
        colModel: colModel_dispatch,
        selectionModel: { type: 'row' },

        columnTemplate: {
            align: 'center', valign: 'center'
        },
        editable: false,
        freezeCols: 5,
        freezeRows: 0,                        
                                
        numberCell: { show: false },
        reactive: true,
        roundCorners: false,
        resizable: true,

        showHeader: true,
        showTitle: false,
        showToolbar: false,
        showTop: false,
        showBottom: false,
        virtualX: true, virtualY: true,

        title: "",
        strNoRows : '조회된 데이터가 없습니다.',
    };
    
    var grid_reservation;
    

    $('#pop_reservation').dialog({
        dialogClass: 'popup',
        width: 1520,
        title: ' ',
        maxHeight: $(window).height(),
        modal: true,
        buttons: [{
                text: "취소",
                class: "btn btn_md btn_gray btn_outline",
                click: function () {
                    $(this).dialog("close");
                }
            },
            {
                text: "수정",  
                class: "btn btn_md btn_blue",
                click: function () {
                    $(this).dialog("close");
                }
            }
        ],
        open: function() {
            $('.startPoint').autocomplete({
                source : arr_start,
                minLength : 0
            }).focus(function() {
                $(this).autocomplete("search", $(this).val());
            });
            
            $('.endPoint').autocomplete({
                source : arr_end,
                minLength : 0
            }).focus(function() {
                $(this).autocomplete("search", $(this).val());
            });

            grid_reservation = pq.grid("#grid_reservation", options_dispatch);
            var mc = [],
            CM = grid_reservation.option("colModel"),
            data = grid_reservation.option("dataModel.data");

            for(var i = 0; i < data.length; i ++) {
                mc.push({r1: i, c1: 5, rc: 1, cc: CM.length});
            }

            grid_reservation.option('mergeCells', mc);
            grid_reservation.refreshView();

            createMap(mapData, carGpsData, '무주읍', 'adminDong');
        },
        focus: function(event, ui) {
            $('input:visible:first-child' , $(this)).blur();
        }
    });
});
</script>

</html>